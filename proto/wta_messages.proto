syntax = "proto3";

package wta.pb;

// ==================== 基础数据类型 ====================

message Vec2 {
  float x = 1;
  float y = 2;
}

message AmmoState {
  int32 missile = 1;
  int32 bomb = 2;
  int32 rocket = 3;
}

// 弹夹详细信息
message MagazineDetail {
  string name = 1;        // 弹夹类名（如 "2Rnd_GBU12_LGB"）
  int32 ammo_count = 2;   // 剩余弹药数
  bool loaded = 3;        // 是否装载中
  int32 type = 4;         // 类型
  string location = 5;    // 位置（如 "vest", "uniform", "backpack"）
}

enum PlatformRole {
  PLATFORM_ROLE_ANTI_PERSONNEL = 0;  // 对应 C++ AntiPersonnel
  PLATFORM_ROLE_ANTI_ARMOR = 1;      // 对应 C++ AntiArmor
  PLATFORM_ROLE_MULTI_ROLE = 2;      // 对应 C++ MultiRole
  PLATFORM_ROLE_UNKNOWN = 3;         // 对应 C++ Unknown
}

enum TargetKind {
  TARGET_KIND_INFANTRY = 0;    // 对应 C++ Infantry
  TARGET_KIND_ARMOR = 1;       // 对应 C++ Armor
  TARGET_KIND_SAM = 2;         // 对应 C++ SAM
  TARGET_KIND_OTHER = 3;       // 对应 C++ Other
  TARGET_KIND_UNKNOWN = 4;     // 对应 C++ Unknown (不使用)
}

message PlatformState {
  int32 id = 1;
  PlatformRole role = 2;
  Vec2 pos = 3;
  bool alive = 4;
  float hit_prob = 5;
  float cost = 6;
  float max_range = 7;
  int32 max_targets = 8;
  int32 quantity = 9;
  AmmoState ammo = 10;
  repeated int32 target_types = 11;
  string platform_type = 12;           // 平台类型名称（如 "B_UAV_02_dynamicLoadout_F"）
  repeated MagazineDetail magazines = 13;  // 弹夹详细信息列表
  float fuel = 14;                     // 剩余油量 (0.0-1.0)
  float damage = 15;                   // 总体损伤 (0.0-1.0, 0=无损伤, 1=完全损毁)
}

message TargetState {
  int32 id = 1;
  TargetKind kind = 2;
  Vec2 pos = 3;
  bool alive = 4;
  float value = 5;
  int32 tier = 6;
  string target_type = 7;                  // 目标类型名称（如 "预警雷达站"）
  repeated int32 prerequisite_targets = 8; // 前置目标ID列表（时序约束必需）
}

// ==================== 消息类型 ====================

// 战场状态上报
message StatusReportEvent {
  double timestamp = 1;
  repeated PlatformState platforms = 2;
  repeated TargetState targets = 3;
}

// 实体击毁事件
message EntityKilledEvent {
  double timestamp = 1;
  int32 entity_id = 2;
  string entity_type = 3;  // "platform" or "target"
  string killed_by = 4;
}

// 伤害事件
message DamageEvent {
  double timestamp = 1;
  int32 entity_id = 2;
  string entity_type = 3;
  float damage_amount = 4;
  string source = 5;
}

// 开火事件
message FiredEvent {
  double timestamp = 1;
  int32 platform_id = 2;
  int32 target_id = 3;
  string weapon = 4;
  int32 ammo_left = 5;
}

// WTA规划请求
message PlanRequest {
  double timestamp = 1;
  string reason = 2;  // "replan", "ttl_expired", "manual"
  repeated PlatformState platforms = 3;
  repeated TargetState targets = 4;
}

// 规划统计
message PlanStats {
  double computation_time = 1;
  int32 iterations = 2;
  bool is_valid = 3;
  double coverage_rate = 4;
}

// WTA规划响应
message PlanResponse {
  string status = 1;  // "ok", "error", "no_solution"
  double timestamp = 2;
  double best_fitness = 3;
  map<int32, int32> assignment = 4;  // platform_id -> target_id
  int32 n_platforms = 5;
  int32 n_targets = 6;
  PlanStats stats = 7;
  double ttl_sec = 8;
  string error_msg = 9;
}

// 日志级别
enum LogLevel {
  LOG_LEVEL_DEBUG = 0;
  LOG_LEVEL_INFO = 1;
  LOG_LEVEL_WARNING = 2;
  LOG_LEVEL_ERROR = 3;
  LOG_LEVEL_FATAL = 4;
}

// 日志消息
message LogMessage {
  double timestamp = 1;          // Unix 时间戳
  LogLevel level = 2;            // 日志级别
  string file = 3;               // 源文件名
  int32 line = 4;                // 行号
  string function = 5;           // 函数名
  string message = 6;            // 日志内容
  int32 thread_id = 7;           // 线程 ID
  string component = 8;          // 组件名称（如 "Orchestrator", "WorldSampler"）
}

// ==================== 统一消息包装器 ====================

message WTAMessage {
  oneof payload {
    StatusReportEvent status_report = 1;
    EntityKilledEvent entity_killed = 2;
    DamageEvent damage = 3;
    FiredEvent fired = 4;
    PlanRequest plan_request = 5;
    PlanResponse plan_response = 6;
    LogMessage log = 7;
  }
}
